name: main-deploy
run-name: ${{ github.actor }} is starting deployment ğŸš€
on:
  pull_request:
    branches:
      - main

jobs:
  Deploy:
    runs-on: ubuntu-latest

    env:
      APP_IDENTIFIER: ${{ github.ref_name }}-${{ secrets.PROJECT_NAME }}
      DEPLOY_DIR: ${{ secrets.SERVER_DEFAULT_PATH }}/${{ github.ref_name }}-${{ secrets.PROJECT_NAME }}

    steps:
      - name: ì‹¤í–‰ ì•Œë¦¼
        run: echo "ğŸš€ ${{ github.actor }} ë‹˜ì´ ë°°í¬ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤!"
      - run: echo "ğŸ‰ ì‘ì—…ì´ ${{ github.event_name }} ì´ë²¤íŠ¸ì— ì˜í•´ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ì—ˆìŠµë‹ˆë‹¤."
      - run: echo "ğŸ§ ì´ ì‘ì—…ì€ GitHubì—ì„œ í˜¸ìŠ¤íŒ…í•˜ëŠ” ${{ runner.os }} ì„œë²„ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
      - run: echo "ğŸ” ë¸Œëœì¹˜ ì´ë¦„ì€ ${{ github.ref }}ì´ê³ , ì €ì¥ì†ŒëŠ” ${{ github.repository }}ì…ë‹ˆë‹¤."
      - run: echo "ğŸ“¦ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ ì¤‘ì¸ ì»¤ë°‹ì€ ${{ github.sha }}ì…ë‹ˆë‹¤."

      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      - run: echo "ğŸ’¡ ${{ github.repository }} ì €ì¥ì†Œê°€ ëŸ¬ë„ˆì— í´ë¡ ë˜ì—ˆìŠµë‹ˆë‹¤."
      - run: echo "ğŸ–¥ï¸ ì›Œí¬í”Œë¡œìš°ê°€ ì´ì œ ëŸ¬ë„ˆì—ì„œ ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: package.json version ê°€ì ¸ì˜¤ê¸°
        id: get_version
        run: echo "VERSION=$(jq -r '.version' package.json)" >> $GITHUB_ENV

      - run: echo "ğŸ“¦ package.jsonì˜ ë²„ì „ì€ ${{ env.VERSION }}ì…ë‹ˆë‹¤."

      - name: ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ ëª©ë¡
        run: ls ${{ github.workspace }}

      - run: echo "ğŸ ì´ ì‘ì—…ì˜ ìƒíƒœëŠ” ${{ job.status }}ì…ë‹ˆë‹¤."

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4.0.2
        with:
          node-version: 22

      - name: corepack í™œì„±í™” ë° pnpm ë²„ì „ ì§€ì •
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: pnpm ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store/v10
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: pnpm ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - run: echo "ğŸ‰ pnpm ì˜ì¡´ì„±ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ë¹Œë“œ ì „ ê²€ì‚¬
        run: pnpm predeploy

      - run: echo "âœ… ë¹Œë“œ ì „ ê²€ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: pnpm ë¹Œë“œ
        run: pnpm build

      - run: echo "ğŸ“¦ pnpm ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ì„œë²„ì— ëª©ì ì§€ í´ë” ìƒì„±
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            mkdir -p ${{ env.DEPLOY_DIR }}

      - run: echo "ğŸ“‚ ì„œë²„ì— ë°°í¬ ë””ë ‰í† ë¦¬(${{ env.DEPLOY_DIR }})ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ì„œë²„ë¡œ ì†ŒìŠ¤ ë³µì‚¬
        uses: appleboy/scp-action@master
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          source: "./dist/*"
          target: "${{ env.DEPLOY_DIR }}"
          strip_components: 1 # (dist ë‚´ë¶€ í´ë”ë§Œ ì˜®ê¸¸ ë•Œ ì‚¬ìš©, ìƒí™© ë”°ë¼ ìƒëµ)
          rm: true            # (ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì›í•˜ë©´ true)
          overwrite: true     # (ê°™ì€ ì´ë¦„ íŒŒì¼ ë®ì–´ì“°ê¸°)

      - run: echo "ğŸ“¤ ì†ŒìŠ¤ íŒŒì¼ì´ ì„œë²„ì˜ ë°°í¬ ë””ë ‰í† ë¦¬(${{ env.DEPLOY_DIR }})ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ì„œë²„ì—ì„œ Docker ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            cd ${{ env.DEPLOY_DIR }}
            docker stop ${{ env.APP_IDENTIFIER }} || true
            docker rm ${{ env.APP_IDENTIFIER }} || true
            docker run -d \
              --name ${{ env.APP_IDENTIFIER }} \
              --network nginx-proxy-manager_default \
              -v $(pwd):/usr/share/nginx/html \
              nginx:alpine

      - run: echo "ğŸš€ ì„œë²„ì—ì„œ Docker ì»¨í…Œì´ë„ˆê°€ package.json ë²„ì „ ${{ env.VERSION }}ìœ¼ë¡œ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."


