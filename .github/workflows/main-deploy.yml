# Required secrets: SSH_PRIVATE_KEY, SSH_HOST, SSH_PORT, SSH_USER_NAME,
# SERVER_DEFAULT_PATH, PROJECT_NAME. Optional: NGINX_CONFIG_DIR (defaults to SERVER_DEFAULT_PATH/nginx-conf)
name: main-deploy

run-name: >
  ${{ github.event_name == 'workflow_dispatch' && 'ðŸ› ï¸ ìˆ˜ë™ ë¦´ë¦¬ì¦ˆ ì‹¤í–‰' || 'ðŸš€ ë¦´ë¦¬ì¦ˆ ìžë™ ìƒì„±' }}
  #${{ github.run_number }}
  by @${{ github.actor }}

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  Deploy:
    runs-on: ubuntu-latest

    env:
      APP_IDENTIFIER: ${{ github.base_ref || github.ref_name }}-${{ secrets.PROJECT_NAME }}
      DEPLOY_DIR: ${{ secrets.SERVER_DEFAULT_PATH }}/${{ github.ref_name }}-${{ secrets.PROJECT_NAME }}
      NGINX_CONFIG_DIR: ${{ secrets.SERVER_DEFAULT_PATH }}/nginx-conf

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck and lint
        run: pnpm run typecheck && pnpm run lint

      - name: Build
        run: pnpm run build

      - name: Create deploy directory on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            mkdir -p ${{ env.DEPLOY_DIR }}
            mkdir -p ${{ env.NGINX_CONFIG_DIR }}

      - name: Copy nginx SPA config to server
        uses: appleboy/scp-action@v0.1.7
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          source: "deploy/spa.conf"
          target: "${{ env.NGINX_CONFIG_DIR }}/"

      - name: Copy dist to server
        uses: appleboy/scp-action@v0.1.7
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          source: "./dist/*"
          target: "${{ env.DEPLOY_DIR }}"
          strip_components: 1
          rm: true
          overwrite: true

      - name: Run Docker container on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            cd ${{ env.DEPLOY_DIR }}
            docker stop ${{ env.APP_IDENTIFIER }} || true
            docker rm ${{ env.APP_IDENTIFIER }} || true
            docker run -d \
              --name ${{ env.APP_IDENTIFIER }} \
              --network nginx-proxy-manager_default \
              -v $(pwd):/usr/share/nginx/html \
              -v ${{ env.NGINX_CONFIG_DIR }}/spa.conf:/etc/nginx/conf.d/default.conf:ro \
              nginx:alpine

      - name: GitHub Summary
        shell: bash
        run: |
          echo "## Deployed commits" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(jq '.commits | length // 0' $GITHUB_EVENT_PATH 2>/dev/null || echo "0")
          if [ "$TOTAL" = "0" ] || [ -z "$TOTAL" ]; then
            echo "- \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          else
            jq -r '.commits[:10][] | "- " + ((.message | split("\n")[0] // "") | gsub("`"; "'\''")) + " (`" + (.id | .[0:7]) + "`)"' $GITHUB_EVENT_PATH >> $GITHUB_STEP_SUMMARY
            if [ "$TOTAL" -gt 10 ] 2>/dev/null; then
              EXTRA=$((TOTAL - 10))
              echo "- ... (ì™¸ ${EXTRA}ê°œ)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
