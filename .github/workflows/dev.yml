name: dev-deploy
run-name: ${{ github.actor }} is starting deployment ğŸš€

on:
  push:
    branches:
      - dev

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ì‹¤í–‰ ì•Œë¦¼
        run: echo "ğŸš€ ${{ github.actor }} ë‹˜ì´ ë°°í¬ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤!"

      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4.0.2
        with:
          node-version: 24

      - name: npm ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: npm ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - run: echo "ğŸ‰ npm ì˜ì¡´ì„±ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ë¹Œë“œ ì „ ê²€ì‚¬(í…ŒìŠ¤íŠ¸/ë¦°íŠ¸ ë“±)
        run: npm run predeploy

      - run: echo "âœ… ë¹Œë“œ ì „ ê²€ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

  build:
    runs-on: ubuntu-latest
    needs: test

    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4.0.2
        with:
          node-version: 24

      - name: npm ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: npm ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: npm ë¹Œë“œ
        run: npm run build

      - run: echo "ğŸ“¦ npm ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: package.json version ê°€ì ¸ì˜¤ê¸°
        id: get_version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - run: echo "ğŸ“¦ package.jsonì˜ ë²„ì „ì€ ${{ env.VERSION }}ì…ë‹ˆë‹¤."

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: build-dist-${{ steps.get_version.outputs.version }}
          path: dist
          if-no-files-found: error

  deploy-files:
    runs-on: ubuntu-latest
    needs: build

    env:
      APP_IDENTIFIER: ${{ github.base_ref || github.ref_name }}-${{ secrets.PROJECT_NAME }}
      DEPLOY_DIR: ${{ secrets.SERVER_DEFAULT_PATH }}/${{ github.ref_name }}-${{ secrets.PROJECT_NAME }}
      NGINX_CONFIG_DIR: ${{ secrets.SERVER_DEFAULT_PATH }}/nginx-conf

    steps:
      - run: echo "ğŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë°°í¬ë¥¼ ì‹œì‘í•œë‹¤. ë²„ì „: ${{ needs.build.outputs.version }}"

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ needs.build.outputs.version }}
          path: dist

      - name: ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ ëª©ë¡ (ë°°í¬ìš© ì›Œí¬ìŠ¤í˜ì´ìŠ¤)
        run: ls ${{ github.workspace }}

      - name: ì„œë²„ì— ëª©ì ì§€ í´ë” ìƒì„±
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            mkdir -p ${{ env.DEPLOY_DIR }}

      - run: echo "ğŸ“‚ ì„œë²„ì— ë°°í¬ ë””ë ‰í† ë¦¬(${{ env.DEPLOY_DIR }})ê°€ ìƒì„±ë˜ì—ˆë‹¤."

      - name: ì„œë²„ë¡œ ì†ŒìŠ¤ ë³µì‚¬
        uses: appleboy/scp-action@master
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          source: "./dist/*"
          target: "${{ env.DEPLOY_DIR }}"
          strip_components: 1
          rm: true
          overwrite: true

      - run: echo "ğŸ“¤ ì†ŒìŠ¤ íŒŒì¼ì´ ì„œë²„ì˜ ë°°í¬ ë””ë ‰í† ë¦¬(${{ env.DEPLOY_DIR }})ë¡œ ë³µì‚¬ë˜ì—ˆë‹¤."

  run-docker:
    runs-on: ubuntu-latest
    needs: 
      - build
      - deploy-files

    env:
      VERSION: ${{ needs.build.outputs.version }}
      APP_IDENTIFIER: ${{ github.base_ref || github.ref_name }}-${{ secrets.PROJECT_NAME }}
      DEPLOY_DIR: ${{ secrets.SERVER_DEFAULT_PATH }}/${{ github.ref_name }}-${{ secrets.PROJECT_NAME }}
      NGINX_CONFIG_DIR: ${{ secrets.SERVER_DEFAULT_PATH }}/nginx-conf

    steps:
      - run: echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ì„ ì§„í–‰í•œë‹¤. ë²„ì „: ${{ env.VERSION }}"

      - name: ì„œë²„ì—ì„œ Docker ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            cd ${{ env.DEPLOY_DIR }}
            docker stop ${{ env.APP_IDENTIFIER }} || true
            docker rm ${{ env.APP_IDENTIFIER }} || true
            docker run -d \
              --name ${{ env.APP_IDENTIFIER }} \
              --network nginx-proxy-manager_default \
              -v $(pwd):/usr/share/nginx/html \
              -v ${{ env.NGINX_CONFIG_DIR }}/spa.conf:/etc/nginx/conf.d/default.conf:ro \
              nginx:alpine

      - run: echo "ğŸš€ ì„œë²„ì—ì„œ Docker ì»¨í…Œì´ë„ˆê°€ package.json ë²„ì „ ${{ env.VERSION }}ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆë‹¤."
