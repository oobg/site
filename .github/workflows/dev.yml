name: dev-deploy
run-name: ${{ github.actor }} is starting deployment ğŸš€
on:
  push:
    branches:
      - dev

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì‹¤í–‰ ì•Œë¦¼
        run: echo "ğŸš€ ${{ github.actor }} ë‹˜ì´ ë°°í¬ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤!"
      - run: echo "ğŸ‰ ì‘ì—…ì´ ${{ github.event_name }} ì´ë²¤íŠ¸ì— ì˜í•´ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ì—ˆìŠµë‹ˆë‹¤."
      - run: echo "ğŸ§ ì´ ì‘ì—…ì€ GitHubì—ì„œ í˜¸ìŠ¤íŒ…í•˜ëŠ” ${{ runner.os }} ì„œë²„ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
      - run: echo "ğŸ” ë¸Œëœì¹˜ ì´ë¦„ì€ ${{ github.ref }}ì´ê³ , ì €ì¥ì†ŒëŠ” ${{ github.repository }}ì…ë‹ˆë‹¤."

      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      - run: echo "ğŸ’¡ ${{ github.repository }} ì €ì¥ì†Œê°€ ëŸ¬ë„ˆì— í´ë¡ ë˜ì—ˆìŠµë‹ˆë‹¤."
      - run: echo "ğŸ–¥ï¸ ì›Œí¬í”Œë¡œìš°ê°€ ì´ì œ ëŸ¬ë„ˆì—ì„œ ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ ëª©ë¡
        run: ls ${{ github.workspace }}
      - run: echo "ğŸ ì´ ì‘ì—…ì˜ ìƒíƒœëŠ” ${{ job.status }}ì…ë‹ˆë‹¤."

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4.0.2
        with:
          node-version: 22

      - name: npm ì˜ì¡´ì„± ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: npm ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      - run: echo "ğŸ‰ npm ì˜ì¡´ì„±ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: npm ë¹Œë“œ
        run: npm run build
      - run: echo "ğŸ“¦ npm ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ì„œë²„ì— ëª©ì ì§€ í´ë” ìƒì„±
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            mkdir -p ${{ secrets.FRONT_PATH }}

      - name: ì„œë²„ë¡œ ì†ŒìŠ¤ ë³µì‚¬
        run: scp -P ${{ secrets.SSH_PORT }} -r ./build/* ${{ secrets.SSH_USER_NAME }}@${{ secrets.SSH_HOST }}:${{ secrets.FRONT_PATH }}

      - name: ì„œë²„ì—ì„œ Docker ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.0
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER_NAME }}
          script: |
            cd ${{ secrets.FRONT_PATH }}
            sudo docker stop raven-front || true
            sudo docker rm raven-front || true
            sudo docker build -t raven-front:latest .
            sudo docker run -d --name raven-front -p 80:80 raven-front:latest


