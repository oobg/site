#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

set -e

branch=$(git rev-parse --abbrev-ref HEAD)

# dev 브랜치에서만 동작
if [ "$branch" != "dev" ]; then
  exit 0
fi

# 사용자가 이미 package.json을 스테이지했다면 존중하고 스킵
if git diff --cached --name-only | grep -q '^package.json$'; then
  exit 0
fi

# 작업 트리의 변경을 검사(코드 변경 있을 때만)
if ! git diff --cached --name-only | grep -E '\.(ts|tsx)$|^src/' >/dev/null 2>&1; then
  exit 0
fi

# 현재 버전과 리모트 기준 버전 비교(옵션). 간단히 로컬만 증가
before=$(jq -r '.version' package.json 2>/dev/null || echo "")

# 패치 버전 증가
node -e "try{const fs=require('fs');const cp=require('child_process');cp.execSync('npm version patch --no-git-tag-version',{stdio:'inherit'});cp.execSync('git add package.json',{stdio:'inherit'})}catch(e){process.exit(1)}"

after=$(jq -r '.version' package.json 2>/dev/null || echo "")

if [ "$before" != "$after" ]; then
  echo "bump version: $before -> $after"
  echo "버전이 증가되어 새 커밋이 추가되었습니다. 다시 push 해 주세요."
  exit 1
fi

exit 0

